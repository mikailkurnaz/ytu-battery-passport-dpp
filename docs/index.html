(function () {
  var app = document.getElementById("app");
  if (!app) {
    document.body.innerHTML = "<h2>#app bulunamadı</h2>";
    return;
  }

  function esc(x) {
    var s = (x === null || x === undefined) ? "" : String(x);
    return s
      .replace(/&/g, "&amp;")
      .replace(/</g, "&lt;")
      .replace(/>/g, "&gt;")
      .replace(/"/g, "&quot;")
      .replace(/'/g, "&#039;");
  }

  function icon(name) {
    return '<i data-lucide="' + name + '" style="width:18px;height:18px;"></i>';
  }

  function createIconsSafe() {
    try {
      if (window.lucide && window.lucide.createIcons) window.lucide.createIcons();
    } catch (e) {}
  }

  // === SADECE İSTEDİĞİN 2 DEĞİŞİKLİK + ROL MODLARI ===
  // 1) "Makine okunur" sekmesi YOK
  // 2) Uyumluluk sekmesinde EU Battery Regulation & ESPR altındaki madde listeleri YOK -> sadece "Uyumlu (Demo)"
  // 3) Header'da 3 mod butonu: Kamuya Açık / Profesyonel / Denetleyici Mekanizma
  //    - Kamuya Açık: overview, carbon, performance, circularity
  //    - Profesyonel: overview, carbon, materials, performance, circularity
  //    - Denetleyici: tüm sekmeler (compliance dahil)

  var state = {
    tab: "overview",
    view: "public", // varsayılan: Kamuya Açık
    data: null,
    error: null
  };

  var TABS = [
    { id: "overview", label: "Genel Bakış", icon: "battery" },
    { id: "carbon", label: "Karbon Ayak İzi", icon: "leaf" },
    { id: "materials", label: "Malzeme Kompozisyonu", icon: "package" },
    { id: "performance", label: "Performans", icon: "zap" },
    { id: "circularity", label: "Döngüsel Ekonomi", icon: "recycle" },
    { id: "compliance", label: "Uyumluluk", icon: "shield" }
  ];

  function allowedTabIds(view) {
    if (view === "public") return ["overview", "carbon", "performance", "circularity"];
    if (view === "professional") return ["overview", "carbon", "materials", "performance", "circularity"];
    return ["overview", "carbon", "materials", "performance", "circularity", "compliance"]; // controller
  }

  function ensureTabAllowed() {
    var allowed = allowedTabIds(state.view);
    if (allowed.indexOf(state.tab) === -1) state.tab = allowed[0];
  }

  function viewLabel(view) {
    if (view === "public") return "Kamuya Açık";
    if (view === "professional") return "Profesyonel";
    return "Denetleyici Mekanizma";
  }

  // --- Varsayılan içerik (JSON okunamazsa demo yine dolu görünsün diye) ---
  var DEFAULT = {
    batteryData: {
      id: "NMC-BAT-2025-FR-8105",
      manufacturer: "Veri mevcut değil",
      model: "Çekiş Bataryası - NMC 811",
      batteryType: "Çekiş bataryası (Traction Battery)",
      capacity: "Prototip model - alanına göre değişken",
      chemistry: "NMC 811 (80% Ni, 10% Mn, 10% Co)",
      manufactureDate: "2025",
      manufactureCountry: "Fransa",
      warranty: "Veri mevcut değil",
      passportVersion: "v1.0",
      lastUpdate: "Veri mevcut değil"
    },
    carbonFootprint: {
      total: 77,
      unit: "kgCO₂e/kWh",
      reference: "Aulanier et al., 2023",
      stages: { rawMaterial: 35, manufacturing: 28, transport: 8, endOfLife: 6 },
      note: "Çekiş bataryası için özel hesaplama - kapasite bazında normalize edilmiştir"
    },
    materials: [
      { name: "Nikel (Ni)", percentage: 42, recyclable: true, source: "Veri mevcut değil", recycledContent: "Veri mevcut değil" },
      { name: "Mangan (Mn)", percentage: 8, recyclable: true, source: "Veri mevcut değil", recycledContent: "Veri mevcut değil" },
      { name: "Kobalt (Co)", percentage: 8, recyclable: true, source: "Veri mevcut değil", recycledContent: "Veri mevcut değil" },
      { name: "Lityum (Li)", percentage: 7, recyclable: true, source: "Veri mevcut değil", recycledContent: "Veri mevcut değil" },
      { name: "Grafit", percentage: 15, recyclable: true, source: "Veri mevcut değil", recycledContent: "Veri mevcut değil" },
      { name: "Alüminyum", percentage: 12, recyclable: true, source: "Veri mevcut değil", recycledContent: "Veri mevcut değil" },
      { name: "Diğer", percentage: 8, recyclable: false, source: "Veri mevcut değil", recycledContent: "Veri mevcut değil" }
    ],
    performance: {
      energyDensity: "Prototip model - kapasite değişken",
      powerDensity: "Veri mevcut değil",
      cycleLife: "Veri mevcut değil",
      chargingTime: "Veri mevcut değil",
      operatingTemp: "Veri mevcut değil",
      stateOfHealth: "Yeni üretim - %100"
    },
    circularity: {
      repairability: "Veri mevcut değil",
      recyclability: "Veri mevcut",
      recycledContent: "Veri mevcut değil",
      dismantlingInfo: "Veri mevcut",
      secondLife: "Veri mevcut değil",
      safetyDataSheet: "Veri mevcut"
    }
  };

  function normalizeData(json) {
    json = json || {};

    var batteryData = DEFAULT.batteryData;
    try {
      if (json.passport && json.passport.id) batteryData.id = json.passport.id;
      if (json.passport && json.passport.version) batteryData.passportVersion = json.passport.version;
      if (json.passport && json.passport.lastUpdate) batteryData.lastUpdate = json.passport.lastUpdate;

      if (json.battery) {
        if (json.battery.manufacturer) batteryData.manufacturer = json.battery.manufacturer;
        if (json.battery.model) batteryData.model = json.battery.model;
        if (json.battery.batteryType) batteryData.batteryType = json.battery.batteryType;
        if (json.battery.capacity) batteryData.capacity = json.battery.capacity;

        if (json.battery.chemistry) {
          batteryData.chemistry = json.battery.chemistry.label || json.battery.chemistry.code || batteryData.chemistry;
        }

        if (json.battery.manufacturing) {
          if (json.battery.manufacturing.year) batteryData.manufactureDate = json.battery.manufacturing.year;
          if (json.battery.manufacturing.country) batteryData.manufactureCountry = json.battery.manufacturing.country;
        }
      }
    } catch (e) {}

    var cf = DEFAULT.carbonFootprint;
    try {
      if (json.carbonFootprint) {
        if (json.carbonFootprint.total !== undefined) cf.total = json.carbonFootprint.total;
        if (json.carbonFootprint.unit) cf.unit = json.carbonFootprint.unit;
        if (json.carbonFootprint.reference) cf.reference = json.carbonFootprint.reference;
        if (json.carbonFootprint.stages) cf.stages = json.carbonFootprint.stages;
        if (json.carbonFootprint.note) cf.note = json.carbonFootprint.note;
      }
    } catch (e) {}

    var materials = DEFAULT.materials;
    try {
      if (Array.isArray(json.materials) && json.materials.length) materials = json.materials;
    } catch (e) {}

    var perf = DEFAULT.performance;
    try {
      if (json.performance) perf = json.performance;
    } catch (e) {}

    var circ = DEFAULT.circularity;
    try {
      if (json.circularity) circ = json.circularity;
    } catch (e) {}

    return {
      batteryData: batteryData,
      carbonFootprint: cf,
      materials: materials,
      performance: perf,
      circularity: circ
    };
  }

  function headerHTML(d) {
    var b = d.batteryData;

    return (
      '<div class="card">' +
        '<div class="header">' +
          '<div class="brand">' +
            '<div class="logo">' + icon("battery") + '</div>' +
            '<div>' +
              '<h1 class="title">Dijital Batarya Pasaportu</h1>' +
              '<p class="subtitle">EU Battery Regulation 2023/1542 & ESPR (Tez Prototipi)</p>' +
              '<p class="small" style="margin-top:6px;">Görünüm: <b>' + esc(viewLabel(state.view)) + '</b></p>' +
            '</div>' +
          '</div>' +

          // Sağ üst 3 buton
          '<div style="display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end;">' +
            viewButton("public", "Kamuya Açık", "globe") +
            viewButton("professional", "Profesyonel", "briefcase") +
            viewButton("controller", "Denetleyici Mekanizma", "shield") +
          '</div>' +
        '</div>' +

        '<div class="grid4">' +
          miniCard("Pasaport ID", b.id, "") +
          miniCard("Batarya Türü", b.batteryType, "green") +
          miniCard("Kimya", "NMC 811", "purple") +
          miniCard("Üretim Ülkesi", b.manufactureCountry, "amber") +
        '</div>' +
      '</div>'
    );

    function viewButton(viewId, text, ic) {
      var active = (state.view === viewId);
      var style = active
        ? "background:#3b82f6;color:#fff;border:1px solid #3b82f6;"
        : "background:#f3f4f6;color:#374151;border:1px solid #e5e7eb;";
      return (
        '<button data-view="' + viewId + '" class="btn" style="' + style + ' padding:10px 12px; border-radius:12px; font-weight:700;">' +
          icon(ic) + ' ' + esc(text) +
        '</button>'
      );
    }

    function miniCard(k, v, theme) {
      var cls = "mini" + (theme ? (" " + theme) : "");
      var mono = (k === "Pasaport ID") ? "font-family:ui-monospace, monospace;" : "";
      return (
        '<div class="' + cls + '">' +
          '<p class="k">' + esc(k) + '</p>' +
          '<p class="v" style="' + mono + '">' + esc(v) + '</p>' +
        '</div>'
      );
    }
  }

  function tabsHTML() {
    var allowed = allowedTabIds(state.view);
    var out = '<div class="tabs">';
    for (var i = 0; i < TABS.length; i++) {
      var t = TABS[i];
      if (allowed.indexOf(t.id) === -1) continue;

      out +=
        '<button class="tab ' + (state.tab === t.id ? "active" : "") + '" data-tab="' + t.id + '">' +
          icon(t.icon) + ' <span>' + esc(t.label) + '</span>' +
        '</button>';
    }
    out += '</div>';
    return out;
  }

  // --- SEKME İÇERİKLERİ ---
  function overviewHTML(d) {
    var b = d.batteryData;
    return (
      '<h2>Genel Bilgiler</h2>' +
      '<div class="row">' +
        '<div class="box">' +
          kv("Üretici", b.manufacturer, "blue") +
          kv("Kimya Yapısı", b.chemistry, "green") +
          kv("Üretim Yılı", b.manufactureDate, "purple") +
          kv("Üretim Ülkesi", b.manufactureCountry, "amber") +
          kv("Nominal Kapasite", b.capacity, "pink") +
        '</div>' +

        '<div class="box" style="background:linear-gradient(135deg,#ecfdf5,#eff6ff); border-color:#dbeafe;">' +
          '<h3 style="margin:0 0 10px; font-weight:1000; display:flex; gap:8px; align-items:center;">' +
            icon("check-circle") + ' Uyumluluk Durumu' +
          '</h3>' +
          '<div class="small" style="line-height:1.9;">' +
            '• EU Battery Regulation 2023/1542<br/>' +
            '• ESPR Requirements<br/>' +
            '• Due Diligence Regulation<br/>' +
            '• RoHS & REACH Compliant<br/>' +
          '</div>' +

          '<div class="box" style="margin-top:14px; background:#fffbeb; border-color:#fde68a;">' +
            '<h3 style="margin:0 0 8px; font-weight:1000; display:flex; gap:8px; align-items:center;">' +
              icon("alert-circle") + ' Veri Durumu' +
            '</h3>' +
            '<div class="small" style="line-height:1.9;">' +
              '✓ Karbon ayak izi: Mevcut<br/>' +
              '✓ Söküm/geri dönüşüm: Mevcut<br/>' +
              '⚠ Geri dönüştürülmüş içerik: Mevcut değil<br/>' +
              '⚠ İkinci ömür uygunluğu: Mevcut değil<br/>' +
              '⚠ Pasaport güncelleme: Mevcut değil<br/>' +
            '</div>' +
          '</div>' +
        '</div>' +
      '</div>'
    );

    function kv(label, value, color) {
      var border = "#3b82f6";
      if (color === "green") border = "#22c55e";
      if (color === "purple") border = "#a855f7";
      if (color === "amber") border = "#f59e0b";
      if (color === "pink") border = "#ec4899";
      return (
        '<div class="kv" style="border-left-color:' + border + ';">' +
          '<div class="k">' + esc(label) + '</div>' +
          '<div class="v">' + esc(value) + '</div>' +
        '</div>'
      );
    }
  }

  function carbonHTML(d) {
    var cf = d.carbonFootprint;
    var total = Number(cf.total) || 0;
    var st = cf.stages || {};
    var names = {
      rawMaterial: "Hammadde Çıkarımı",
      manufacturing: "Üretim",
      transport: "Taşıma",
      endOfLife: "Ömür Sonu"
    };

    function stageRow(key) {
      var val = Number(st[key]) || 0;
      var pct = total > 0 ? (val / total * 100) : 0;
      return (
        '<div style="margin-bottom:12px;">' +
          '<div style="display:flex; justify-content:space-between; gap:12px;">' +
            '<span style="font-weight:900;">' + esc(names[key] || key) + '</span>' +
            '<span style="font-weight:900;">' + esc(val) + ' ' + esc(cf.unit) + ' (' + pct.toFixed(1) + '%)</span>' +
          '</div>' +
          '<div class="barwrap"><div class="bar" style="width:' + pct + '%;"></div></div>' +
        '</div>'
      );
    }

    return (
      '<div style="display:flex; justify-content:space-between; gap:14px; align-items:flex-start; margin-bottom:12px;">' +
        '<h2 style="margin:0;">Karbon Ayak İzi</h2>' +
        '<div style="text-align:right;">' +
          '<div style="font-size:30px; font-weight:1000; color:#16a34a;">' + esc(cf.total) + ' ' + esc(cf.unit) + '</div>' +
          '<div class="small">Çekiş bataryası için</div>' +
          '<div class="small">Kaynak: ' + esc(cf.reference) + '</div>' +
        '</div>' +
      '</div>' +

      '<div class="box" style="background:#eff6ff; border-color:#bfdbfe;">' +
        '<div class="pill blue">' + icon("alert-circle") + ' Önemli Not</div>' +
        '<div class="muted" style="margin-top:8px;">' +
          esc(cf.note) + ' Bu değer literatüre dayalıdır ve gerçek üretim verisi ile farklılık gösterebilir.' +
        '</div>' +
      '</div>' +

      '<div class="row" style="margin-top:14px;">' +
        '<div class="box">' +
          '<div style="font-weight:1000; margin-bottom:10px;">Tahmini Yaşam Döngüsü Dağılımı</div>' +
          stageRow("rawMaterial") +
          stageRow("manufacturing") +
          stageRow("transport") +
          stageRow("endOfLife") +
        '</div>' +

        '<div class="box" style="background:#ecfdf5; border-color:#bbf7d0;">' +
          '<div style="font-weight:1000; margin-bottom:10px;">Hesaplama Metodolojisi</div>' +
          '<div class="small" style="line-height:1.9;">' +
            '• ISO 14067:2018 - Karbon Ayak İzi<br/>' +
            '• Beşikten kapıya (Cradle-to-gate)<br/>' +
            '• Referans: ' + esc(cf.reference) + '<br/>' +
          '</div>' +
          '<div class="box" style="margin-top:12px; background:#fff;">' +
            '<div class="small">Veri Kalitesi</div>' +
            '<div style="font-weight:1000;">Literatür bazlı tahmin</div>' +
            '<div class="small" style="margin-top:6px;">Gerçek üretim verisi mevcut değil</div>' +
          '</div>' +
        '</div>' +
      '</div>'
    );
  }

  function materialsHTML(d) {
    var mats = d.materials || [];
    var out =
      '<h2>Malzeme Kompozisyonu & Tedarik</h2>' +
      '<div class="box" style="background:#fffbeb; border-color:#fde68a;">' +
        '<div style="display:flex; gap:10px; align-items:flex-start;">' +
          icon("alert-circle") +
          '<div>' +
            '<div style="font-weight:1000;">Veri Durumu</div>' +
            '<div class="small" style="margin-top:4px;">Malzeme tedarik kaynağı ve geri dönüştürülmüş içerik verileri henüz mevcut değildir. Yüzdeler NMC 811 için tipik değerleri temsil eder.</div>' +
          '</div>' +
        '</div>' +
      '</div>' +

      '<div class="box" style="margin-top:14px;">';

    for (var i = 0; i < mats.length; i++) {
      var m = mats[i];
      var pct = Number(m.percentage) || 0;

      out +=
        '<div class="box" style="margin:0 0 10px; border-radius:14px;">' +
          '<div class="mat">' +
            '<div class="matL">' +
              '<div class="badgePct">' + esc(pct) + '%</div>' +
              '<div>' +
                '<div style="font-weight:1000;">' + esc(m.name) + '</div>' +
                '<div class="small">Kaynak: ' + esc(m.source || "Veri mevcut değil") + '</div>' +
                '<div class="small">Geri dönüştürülmüş içerik: ' + esc(m.recycledContent || "Veri mevcut değil") + '</div>' +
              '</div>' +
            '</div>' +
            (m.recyclable
              ? '<span class="pill green">' + icon("recycle") + ' Geri Dönüştürülebilir</span>'
              : '<span class="pill">' + icon("alert-circle") + ' Sınırlı Geri Dönüşüm</span>'
            ) +
          '</div>' +
          '<div class="barwrap" style="margin-top:10px;">' +
            '<div class="bar" style="width:' + pct + '%; background:linear-gradient(90deg,#60a5fa,#a855f7);"></div>' +
          '</div>' +
        '</div>';
    }

    out +=
      '</div>' +

      '<div class="box" style="margin-top:14px; background:#eff6ff; border-color:#bfdbfe;">' +
        '<div style="font-weight:1000; display:flex; gap:8px; align-items:center; margin-bottom:10px;">' +
          icon("shield") + ' Due Diligence & Sorumlu Tedarik' +
        '</div>' +
        '<div class="row">' +
          ddBox("Tedarik Zinciri Şeffaflığı", "Veri toplama aşamasında") +
          ddBox("Çocuk İşçiliği Denetimi", "Değerlendirme beklemede") +
        '</div>' +
        '<div class="row" style="margin-top:10px;">' +
          ddBox("Conflict Minerals", "Sertifikasyon süreci devam ediyor") +
          ddBox("Çevresel Etki", "Değerlendirme yapılacak") +
        '</div>' +
        '<div class="small" style="margin-top:12px; font-style:italic;">* Prototip model için due diligence süreçleri henüz tamamlanmamıştır.</div>' +
      '</div>';

    return out;

    function ddBox(title, text) {
      return (
        '<div class="box" style="background:#fff;">' +
          '<div style="font-weight:1000;">' + esc(title) + '</div>' +
          '<div class="small" style="margin-top:4px;">' + esc(text) + '</div>' +
        '</div>'
      );
    }
  }

  function performanceHTML(d) {
    var p = d.performance || {};
    var labels = {
      energyDensity: "Enerji Yoğunluğu",
      powerDensity: "Güç Yoğunluğu",
      cycleLife: "Çevrim Ömrü",
      chargingTime: "Şarj Süresi",
      operatingTemp: "Çalışma Sıcaklığı",
      stateOfHealth: "Sağlık Durumu (SoH)"
    };

    function perfCard(key) {
      return (
        '<div class="box" style="margin:0; background:linear-gradient(135deg,#f8fafc,#eff6ff);">' +
          '<div class="small">' + esc(labels[key]) + '</div>' +
          '<div style="font-size:18px; font-weight:1000; margin-top:6px;">' + esc(p[key] || "Veri mevcut değil") + '</div>' +
        '</div>'
      );
    }

    return (
      '<h2>Teknik Performans Verileri</h2>' +
      '<div class="box">' +
        '<div style="display:grid; grid-template-columns: repeat(3, minmax(0,1fr)); gap:12px;">' +
          perfCard("energyDensity") +
          perfCard("powerDensity") +
          perfCard("cycleLife") +
          perfCard("chargingTime") +
          perfCard("operatingTemp") +
          perfCard("stateOfHealth") +
        '</div>' +
      '</div>' +

      '<div class="box" style="margin-top:14px; background:#ecfdf5; border-color:#bbf7d0;">' +
        '<div style="font-weight:1000; margin-bottom:10px;">Batarya Test Sonuçları</div>' +
        '<div class="row">' +
          '<div class="box">' +
            '<div style="font-weight:1000; margin-bottom:6px;">Güvenlik Testleri</div>' +
            '<div class="small" style="line-height:1.9;">' +
              '✓ UN 38.3 Transport Test<br/>' +
              '✓ IEC 62133 Safety Test<br/>' +
              '✓ Thermal Runaway Test<br/>' +
              '✓ Vibration & Shock Test<br/>' +
            '</div>' +
          '</div>' +
          '<div class="box">' +
            '<div style="font-weight:1000; margin-bottom:6px;">Performans Testleri</div>' +
            '<div class="small" style="line-height:1.9;">' +
              '✓ Capacity Verification (±2%)<br/>' +
              '✓ Internal Resistance Test<br/>' +
              '✓ Fast Charging Capability<br/>' +
              '✓ Temperature Performance<br/>' +
            '</div>' +
          '</div>' +
        '</div>' +
      '</div>'
    );
  }

  function circularityHTML(d) {
    var c = d.circularity || {};

    function card(title, value, ok) {
      var border = ok ? "#bbf7d0" : "#fde68a";
      var bg = ok ? "#ecfdf5" : "#fffbeb";
      var ic = ok ? "check-circle" : "alert-circle";
      return (
        '<div class="box" style="border-width:2px; border-color:' + border + '; background:' + bg + ';">' +
          '<div style="display:flex; justify-content:space-between; gap:10px; align-items:center; font-weight:1000;">' +
            '<div>' + esc(title) + '</div>' +
            icon(ic) +
          '</div>' +
          '<div style="margin-top:10px; font-weight:900;">' + esc(value || "Veri mevcut değil") + '</div>' +
        '</div>'
      );
    }

    return (
      '<h2>Döngüsel Ekonomi & Sürdürülebilirlik</h2>' +
      '<div class="row">' +
        '<div class="box">' +
          '<div style="display:grid; grid-template-columns: 1fr 1fr; gap:12px;">' +
            card("Onarılabilirlik Skoru", c.repairability, false) +
            card("Geri Dönüşüm Bilgisi", c.recyclability, true) +
            card("Geri Dönüştürülmüş İçerik", c.recycledContent, false) +
            card("İkinci Ömür Uygunluğu", c.secondLife, false) +
          '</div>' +
        '</div>' +

        '<div class="box">' +
          '<div class="box" style="background:#ecfdf5; border-color:#bbf7d0;">' +
            '<div style="font-weight:1000; display:flex; gap:8px; align-items:center; margin-bottom:10px;">' +
              icon("file-text") + ' Mevcut Dökümanlar' +
            '</div>' +
            '<div class="pill green" style="margin-bottom:8px;">' + icon("check-circle") + ' Söküm Talimatları</div>' +
            '<div class="pill green">' + icon("check-circle") + ' Güvenlik Veri Sayfası (SDS)</div>' +
          '</div>' +

          '<div class="box" style="margin-top:12px; background:#fffbeb; border-color:#fde68a;">' +
            '<div style="font-weight:1000; display:flex; gap:8px; align-items:center; margin-bottom:10px;">' +
              icon("alert-circle") + ' Geliştirilecek Alanlar' +
            '</div>' +
            '<div class="small" style="line-height:1.9;">' +
              '• İkinci hayat planlaması (ESS vb.)<br/>' +
              '• Geri dönüşüm partnerleri<br/>' +
              '• Onarılabilirlik değerlendirmesi<br/>' +
            '</div>' +
          '</div>' +

          '<div class="box" style="margin-top:12px; background:#eff6ff; border-color:#bfdbfe;">' +
            '<div class="small"><b>Not:</b> Prototip model için döngüsel ekonomi verileri kısmen mevcuttur. Seri üretimde güncellenecektir.</div>' +
          '</div>' +
        '</div>' +
      '</div>'
    );
  }

  // === Uyumluluk Sekmesi: madde listeleri kaldırıldı, sadece "Uyumlu (Demo)" ===
  function complianceHTML() {
    return (
      '<h2>Düzenleyici Uyumluluk</h2>' +
      '<div class="row">' +
        '<div class="box">' + complianceCard("EU Battery Regulation", "2023/1542", "shield", "#22c55e") + '</div>' +
        '<div class="box">' + complianceCard("ESPR", "Ecodesign Regulation", "leaf", "#3b82f6") + '</div>' +
      '</div>'
    );

    function complianceCard(title, subtitle, ic, color) {
      return (
        '<div class="box" style="border:1px solid #bbf7d0; background:#ecfdf5;">' +
          '<div style="display:flex; gap:10px; align-items:center;">' +
            '<div style="background:' + esc(color) + '; width:42px; height:42px; border-radius:14px; display:flex; align-items:center; justify-content:center; color:white;">' +
              '<i data-lucide="' + esc(ic) + '"></i>' +
            '</div>' +
            '<div>' +
              '<div style="font-weight:1000;">' + esc(title) + '</div>' +
              '<div class="small">' + esc(subtitle) + '</div>' +
            '</div>' +
          '</div>' +
          '<div style="margin-top:12px;">' +
            '<span class="pill green">' + icon("check-circle") + ' Uyumlu (Demo)</span>' +
          '</div>' +
        '</div>'
      );
    }
  }

  function contentHTML(d) {
    ensureTabAllowed();

    if (state.tab === "overview") return overviewHTML(d);
    if (state.tab === "carbon") return carbonHTML(d);
    if (state.tab === "materials") return materialsHTML(d);
    if (state.tab === "performance") return performanceHTML(d);
    if (state.tab === "circularity") return circularityHTML(d);
    if (state.tab === "compliance") return complianceHTML(d);
    return '<div class="muted">Sekme bulunamadı</div>';
  }

  function render() {
    if (state.error) {
      app.innerHTML =
        '<div class="card" style="padding:18px;">' +
          '<div class="pill amber">' + icon("alert-circle") + ' Hata</div>' +
          '<div style="margin-top:10px; font-weight:1000;">' + esc(state.error) + '</div>' +
          '<div class="small" style="margin-top:8px;">Kontrol: docs/passport.json var mı ve adı doğru mu?</div>' +
        '</div>';
      createIconsSafe();
      return;
    }

    if (!state.data) {
      app.innerHTML =
        '<div class="card" style="padding:18px;">' +
          '<div class="pill blue">' + icon("loader") + ' Yükleniyor...</div>' +
          '<div class="small" style="margin-top:10px;">passport.json okunuyor</div>' +
        '</div>';
      createIconsSafe();
      return;
    }

    ensureTabAllowed();

    var d = state.data;
    app.innerHTML =
      headerHTML(d) +
      tabsHTML() +
      '<div class="card content">' + contentHTML(d) + '</div>' +
      '<div class="footer">' +
        '<p>Bu dijital pasaport EU Battery Regulation (2023/1542) ve ESPR gereksinimlerine uygun olarak oluşturulmuştur.</p>' +
        '<p class="small" style="margin-top:6px;">Son Güncelleme: 15 Ocak 2025 | Versiyon: 1.0</p>' +
      '</div>';

    createIconsSafe();
  }

  function loadJSON() {
    state.error = null;
    fetch("./passport.json", { cache: "no-store" })
      .then(function (res) {
        if (!res.ok) throw new Error("passport.json okunamadı (HTTP " + res.status + ")");
        return res.json();
      })
      .then(function (json) {
        state.data = normalizeData(json);
        render();
      })
      .catch(function () {
        state.data = normalizeData(null);
        render();
      });
  }

  document.addEventListener("click", function (e) {
    var viewBtn = e.target.closest ? e.target.closest("[data-view]") : null;
    if (viewBtn) {
      state.view = viewBtn.getAttribute("data-view");
      ensureTabAllowed();
      render();
      return;
    }

    var tabBtn = e.target.closest ? e.target.closest("[data-tab]") : null;
    if (tabBtn) {
      var id = tabBtn.getAttribute("data-tab");
      if (allowedTabIds(state.view).indexOf(id) !== -1) {
        state.tab = id;
        render();
      }
      return;
    }
  });

  render();
  loadJSON();
})();
